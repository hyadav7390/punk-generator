# IPFS Setup for `punk-generator`

These files let you run a **public IPFS (Kubo)** node on Ubuntu 24.04 and pin the collection generated by `generatePunks.py` (default output: the `generated/` folder).

> TL;DR
>
> ```bash
> # 1) Install Docker + Compose plugin (first time only)
> curl -fsSL https://get.docker.com | sh
> sudo usermod -aG docker $USER && newgrp docker
>
> # 2) Start IPFS
> docker compose up -d
> ./scripts/ipfs_configure.sh
>
> # 3) Open firewall for peers (Swarm) and the public Gateway
> sudo ufw allow 4001/tcp && sudo ufw allow 4001/udp && sudo ufw allow 8080/tcp
>
> # 4) Generate punks (from repo root) then pin the folder
> python3 -m venv .venv && source .venv/bin/activate
> pip install -r requirements.txt
> python generatePunks.py
> ./scripts/pin_generated.sh generated
> ```
>
> After pinning, you'll get a root CID you can use as:
> - `ipfs://<ROOT_CID>`
> - `http://127.0.0.1:8080/ipfs/<ROOT_CID>`
> - `http://<YOUR_SERVER_IP>:8080/ipfs/<ROOT_CID>`
> - If you set a domain: `https://<your-gateway-domain>/ipfs/<ROOT_CID>`

---

## What you get

- **`docker-compose.yml`**: runs the official `ipfs/kubo` container with:
  - Swarm (libp2p) ports open to the internet (`4001/tcp` and `4001/udp`) so your node is reachable
  - Gateway (`8080`) exposed (OK to make public)
  - API (`5001`) bound to **localhost only** for safety
- **`scripts/ipfs_configure.sh`**: applies safe addresses (`API` on `127.0.0.1:5001`, `Gateway` on `0.0.0.0:8080`) and server profile
- **`scripts/pin_generated.sh`**: pins the `generated/` directory and prints the root CID + helpful gateway URLs
- **`nginx/ipfs-gateway.conf`**: optional reverse proxy you can enable to serve your **public gateway** on a domain
- **`systemd/ipfs-compose.service`** (optional): keep your IPFS compose stack running at boot

> **Security note:** Never expose the Kubo **API** (default `5001`) to the public internet. Keep it bound to localhost and, if you need remote access, tunnel over SSH.

---

## 1) Prerequisites (Ubuntu 24.04)

Install Docker Engine & Compose plugin:

```bash
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER && newgrp docker
docker --version && docker compose version
```

Enable the uncomplicated firewall and open required ports:

```bash
sudo ufw allow OpenSSH
sudo ufw allow 4001/tcp
sudo ufw allow 4001/udp
sudo ufw allow 8080/tcp
sudo ufw enable
sudo ufw status
```

---

## 2) Start your IPFS node

From the repo root (where `docker-compose.yml` lives):

```bash
docker compose up -d
./scripts/ipfs_configure.sh
```

Check that it's healthy and connected to peers:

```bash
docker compose logs -f ipfs
docker compose exec ipfs ipfs id
docker compose exec ipfs ipfs swarm peers | wc -l
```

---

## 3) Generate and **pin** your punks

`generatePunks.py` writes PNGs to the `generated/` folder by default. Run it and then pin the folder:

```bash
python3 -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
python generatePunks.py

# pin to your local IPFS node
./scripts/pin_generated.sh generated
```

This prints the **root CID**. You can reference your collection as:

- `ipfs://<ROOT_CID>`
- `http://127.0.0.1:8080/ipfs/<ROOT_CID>`
- `http://<YOUR_SERVER_IP>:8080/ipfs/<ROOT_CID>`
- If you set a domain: `https://<your-gateway-domain>/ipfs/<ROOT_CID>`

> By default, `ipfs add -r` **pins** recursively. The script also calls `ipfs pin add` defensively.

---

## 4) Optional: Public HTTPS gateway with nginx

Point a DNS record (e.g., `gateway.example.com`) to your server IP, then install nginx:

```bash
sudo apt update && sudo apt install -y nginx certbot python3-certbot-nginx
sudo cp nginx/ipfs-gateway.conf /etc/nginx/sites-available/ipfs-gateway.conf
sudo sed -i "s/gateway.example.com/<your-gateway-domain>/g" /etc/nginx/sites-available/ipfs-gateway.conf
sudo ln -s /etc/nginx/sites-available/ipfs-gateway.conf /etc/nginx/sites-enabled/ipfs-gateway.conf
sudo nginx -t && sudo systemctl reload nginx
```

Once it serves HTTP, enable TLS with Let's Encrypt:

```bash
sudo certbot --nginx -d <your-gateway-domain>
```

You now have a public HTTPS gateway that proxies to your local Kubo gateway on `127.0.0.1:8080`.

---

## 5) Good practices & tips

- **Keep API private** (`127.0.0.1:5001` only). For remote admin, use SSH port forwarding:
  ```bash
  ssh -L 5001:127.0.0.1:5001 ubuntu@your-server
  # in another shell: export IPFS_API=http://127.0.0.1:5001
  ```
- Ensure inbound connectivity:
  - Open `4001/tcp` and `4001/udp` in the firewall and on your cloud provider security groups.
- Verify content availability from another machine:
  ```bash
  curl -I http://<YOUR_SERVER_IP>:8080/ipfs/<ROOT_CID>
  ```
- Garbage-collection is safe for **pinned** data; you can enable it with the daemon flag if desired.
- Back up `ipfs/data/` if you care about keeping pins and the repo state.

---

## 6) (Optional) systemd to keep things running

If you prefer boot persistence via systemd:

```bash
sudo cp systemd/ipfs-compose.service /etc/systemd/system/ipfs-compose.service
sudo sed -i "s@/path/to/your/repo@$(pwd)@g" /etc/systemd/system/ipfs-compose.service
sudo systemctl daemon-reload
sudo systemctl enable --now ipfs-compose.service
systemctl status ipfs-compose.service
```

---

## Troubleshooting

- **No peers / slow fetches**: ensure ports `4001/tcp` and `4001/udp` are open and that your host IP is publicly reachable.
- **Gateway works locally but not over the internet**: check firewall and that nginx is proxying to `127.0.0.1:8080`.
- **Don't expose** the API `5001` publicly; it gives admin-level control of your node.
- **Want native Kubo instead of Docker?** Follow the official docs and use the same `ipfs` commands.

---

**Happy minting!**
